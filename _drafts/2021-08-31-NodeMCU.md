---
layout: post
title: NodeMCU
date:  2021-08-31 00:00:00 -1000
categories:
---

* TOC
{:toc}

# Getting Started

* [NodeMCU Getting Started Documentation](https://nodemcu.readthedocs.io/en/release/getting-started/)

* [NodeMCU PyFlasher](https://github.com/marcelstoer/nodemcu-pyflasher)

    ```
git clone https://github.com/marcelstoer/nodemcu-pyflasher.git
cd nodemcu-pyflasher
python3 -m venv venv
. venv/bin/activate
pip install -U -f https://extras.wxpython.org/wxPython4/extras/linux/gtk3/ubuntu-18.04 wxPython
pip install -r requirements.txt
    ```

    And then what?

# esptool

```
pip3 install esptool
esptool.py chip_id
```

If all goes well, you now get something like this:

```
esptool.py v3.1
Found 1 serial ports
Serial port /dev/ttyUSB0
Connecting....
Detecting chip type... ESP8266
Chip is ESP8266EX
Features: WiFi
Crystal is 26MHz
MAC: 01:23:56:78:9a:bc
Uploading stub...
Running stub...
Stub running...
Chip ID: 0x01234568
Hard resetting via RTS pin...
```

Specify a different serial port like this: `esptool.py --port /dev/ttyUSB0 chip_id`


# Building firmware with LUA interpreter

The default development language for NodeMCU is LUA. You need to build a LUA interpreter, which can
be found in the [NodeMCU Firmware repo](https://github.com/nodemcu/nodemcu-firmware).

```
git clone --recurse-submodules  https://github.com/nodemcu/nodemcu-firmware.git
cd nodemcu-firmware
make -j $(nproc)
```

This builds a minimal version of the firmware... There are many optional modules that can
be enabled by changing the `./app/include/user_modules.h` and the `./app/include/user_config.h` files and
then recompiling.

After compiling, you'll find the following files in the `./bin/` directory:

```
tom@zen:~/projects/nodemcu/nodemcu-firmware$ ll ./bin/
total 448
drwxrwxr-x  2 tom tom   4096 Aug 31 13:14 ./
drwxrwxr-x 17 tom tom   4096 Aug 31 13:20 ../
-rw-rw-r--  1 tom tom  30064 Aug 31 13:14 0x00000.bin
-rw-rw-r--  1 tom tom 413696 Aug 31 13:14 0x10000.bin
-rw-rw-r--  1 tom tom    110 Aug 31 13:11 .gitignore
```

# Flash the Firmware

The `flash_id` option shows what kind of serial flash PROM is present on your device:

`esptool.py flash_id`

```
esptool.py v3.1
Found 1 serial ports
Serial port /dev/ttyUSB0
Connecting....
Detecting chip type... ESP8266
Chip is ESP8266EX
Features: WiFi
Crystal is 26MHz
MAC: 01:23:56:78:9a:bc
Uploading stub...
Running stub...
Stub running...
Manufacturer: c2
Device: 2516
Detected flash size: 4MB
Hard resetting via RTS pin...
```

In our case, it's a 4MB flash.
    
Flash the just compiled firmware like this:

```
tom@zen:~/projects/nodemcu/nodemcu-firmware$ esptool.py write_flash -fs 4MB -fm dio 0x00000 bin/0x00000.bin 0x10000 bin/0x10000.bin
esptool.py v3.1
Found 1 serial ports
Serial port /dev/ttyUSB0
Connecting....
Detecting chip type... ESP8266
Chip is ESP8266EX
Features: WiFi
Crystal is 26MHz
MAC: 01:23:56:78:9a:bc
Uploading stub...
Running stub...
Stub running...
Configuring flash size...
Flash will be erased from 0x00000000 to 0x00007fff...
Flash will be erased from 0x00010000 to 0x00074fff...
Flash params set to 0x024f
Compressed 30064 bytes to 21820...
Wrote 30064 bytes (21820 compressed) at 0x00000000 in 2.3 seconds (effective 106.3 kbit/s)...
Hash of data verified.
Compressed 413696 bytes to 289359...
Wrote 413696 bytes (289359 compressed) at 0x00010000 in 25.6 seconds (effective 129.2 kbit/s)...
Hash of data verified.

Leaving...
Hard resetting via RTS pin...
```

You can always start from scratch by doing `esptool.py erase_flash`.

# Connect to the NodeMCU through the serial port

```
picocom  -b 115200 /dev/ttyUSB0
```

The first time after starting with a completely empty flash, you'll see something like this:

```
Formatting file system. Please wait...
.........................................................
```

This is then followed by this:

```
NodeMCU 3.0.0.0 
	branch: release
	commit: d4ae3c364bd8ae3ded8b77d35745b7f07879f5f9
	release: 3.0.0-release_20210201 +1
	release DTS: 202105102018
	SSL: false
	build type: float
	LFS: 0x0 bytes total capacity
	modules: adc,bit,dht,file,gpio,i2c,mqtt,net,node,ow,spi,tmr,uart,wifi
 build 2021-08-31 13:13 powered by Lua 5.1.4 on SDK 3.0.1-dev(fce080e)
cannot open init.lua: 
> 
```

You can enter Lua commands at the prompt:

```
> print("Hello World!");
Hello World!
> 
```

# Install LUA on your PC

```
sudo apt install lua5.3
```

# NodeMCU Uploader

Install [nodemcu-uploader.py](https://github.com/kmpm/nodemcu-uploader): 

```
pip install nodemcu-uploader
```

Check out the [Usage manual](https://github.com/kmpm/nodemcu-uploader/blob/master/doc/USAGE.md).

Load `init.lua` to NodeMCU:

```
nodemcu-uploader upload init.lua credentials.lua 
```

```
opening port /dev/ttyUSB0 with 115200 baud
Preparing esp for transfer.
Transferring init.lua as init.lua
Transferring credentials.lua as credentials.lua
All done!
```

After this, start `picocom` again, press the reset button, and you should see something like this:

```
NodeMCU 3.0.0.0 
	branch: release
	commit: d4ae3c364bd8ae3ded8b77d35745b7f07879f5f9
	release: 3.0.0-release_20210201 +1
	release DTS: 202105102018
	SSL: false
	build type: float
	LFS: 0x0 bytes total capacity
	modules: adc,bit,dht,file,gpio,i2c,mqtt,net,node,ow,spi,tmr,uart,wifi
 build 2021-08-31 13:13 powered by Lua 5.1.4 on SDK 3.0.1-dev(fce080e)
Connecting to WiFi access point...
> Connection to AP(MyWifiName) established!
Waiting for IP address...
Wifi connection is ready! IP address is: 192.168.1.52
Startup will resume momentarily, you have 3 seconds to abort.
Waiting...
Running
```
